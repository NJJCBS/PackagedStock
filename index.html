<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stocktake App</title>
  <style>
    /*â€” Overall font and layout â€”*/
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      margin-bottom: 1rem;
    }
    h2 {
      margin-top: 2rem;
      font-size: 1.2rem;
    }
    h2 b {
      font-size: 1.2rem;
    }
    /*â€” Loading indicator â€”*/
    #loading {
      font-style: italic;
    }
    /*â€” Stock list styling â€”*/
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }
    /*â€” Initial count (column C) â€”*/
    .initial {
      opacity: 0.3;
      width: 30px;
      text-align: right;
      margin-right: 8px;
    }
    /*â€” Tick button â€”*/
    .tick {
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 8px;
    }
    /*â€” Name & unit â€”*/
    .name {
      flex: 1;
      font-size: 1rem;
    }
    .unit {
      font-size: 0.7rem;
      color: #555;
      margin-left: 8px;
    }
    /*â€” Quantity input & controls â€”*/
    .qty-control {
      display: flex;
      align-items: center;
      margin-left: 8px;
    }
    .qty-control button {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      padding: 4px;
    }
    .qty-control input {
      width: 50px;
      text-align: center;
      margin: 0 4px;
      font-family: Arial, sans-serif;
    }
    /*â€” Clear (bin) button â€”*/
    .clear {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 8px;
    }
    /*â€” Complete button â€”*/
    #completeBtn {
      margin-top: 24px;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ðŸ“‹ Stocktake</h1>
  <div id="loading">Loadingâ€¦</div>
  <div id="app" style="display:none;">
    <!-- KEGS group -->
    <h2><b>KEGS</b></h2>
    <ul id="kegList"></ul>
    <!-- CANS group -->
    <h2><b>CANS</b></h2>
    <ul id="canList"></ul>
    <button id="completeBtn">Complete</button>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyJT539HNbZcMqXVm_lXB1lwD1VyFd-mVG-q_nCZaKOKc4zxn7Y38jg_u1hpu3g7q7n/exec';

    let rawStock = [];

    // month names to filter out
    const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    async function loadStock() {
      try {
        const res = await fetch(API_URL);
        const { stock } = await res.json();  // stock: [{ rawName, initialCount, quantity }]
        rawStock = stock.map(item => ({
          rawName:       item.rawName || item.name,    // if using old API, fallback to name
          initialCount:  item.initialCount ?? 0,
          quantity:      item.quantity ?? "",
        }));
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        renderLists();
        document.getElementById('completeBtn').onclick = complete;
      } catch (err) {
        console.error(err);
        document.getElementById('loading').textContent = 'Error loading data.';
      }
    }

    function cleanItem(item) {
      let name = item.rawName.trim();

      // 1) filter out month-prefixed entries
      for (let m of MONTHS) {
        if (name.startsWith(m + ' ')) return null;
      }
      // 2) remove leading "NN." prefix
      name = name.replace(/^\d{2}\.\s*/, '');

      // 3) split off ABV and unit
      //    format: "Beer Name // XX.X% 20L KEG" or similar
      const [before, after] = name.split('//');
      name = before ? before.trim() : name;

      // 4) extract unit (last token)
      const tokens = name.split(' ');
      const unit = tokens[tokens.length - 1];
      const cleanName = tokens.slice(0, -1).join(' ');

      return {
        cleanName,
        unit,
        initialCount: item.initialCount,
        quantity: item.quantity
      };
    }

    function renderLists() {
      const kegs = [];
      const cans = [];

      for (let item of rawStock) {
        const c = cleanItem(item);
        if (!c) continue;  // skip month entries

        if (c.unit.toUpperCase().includes('KEG')) kegs.push(c);
        else if (c.unit.toUpperCase().includes('ML')) cans.push(c);
      }

      renderGroup('kegList', kegs);
      renderGroup('canList', cans);
    }

    function renderGroup(listId, items) {
      const ul = document.getElementById(listId);
      ul.innerHTML = '';
      items.forEach((item, i) => {
        const li = document.createElement('li');

        // initial count
        const spanInit = document.createElement('span');
        spanInit.className = 'initial';
        spanInit.textContent = item.initialCount;
        li.append(spanInit);

        // tick button
        const tick = document.createElement('button');
        tick.className = 'tick';
        tick.textContent = 'âœ”ï¸';
        tick.title = 'Carry forward';
        tick.onclick = () => {
          item.quantity = item.initialCount;
          renderLists();
        };
        li.append(tick);
