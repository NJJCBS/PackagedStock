<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stocktake App</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; max-width:600px; margin:auto }
    h1 { margin-bottom:0.5rem; }
    #date { font-weight:normal; font-size:1rem; margin-left:8px; }
    h2 { margin-top:1.5rem; font-size:1.1rem; }
    ul { list-style:none; padding:0; }
    li { display:flex; align-items:center; margin:6px 0; padding:4px; }
    .name { flex:1; font-size:1rem; }
    .unit { font-size:0.7rem; color:#555; margin-left:6px; }
    .initial { opacity:0.3; margin-left:8px; width:30px; text-align:right; }
    .tick, .clear, .qty-control button { background:none; border:none; cursor:pointer; padding:0 4px; font-size:1rem; }
    .qty-control { display:flex; align-items:center; margin-left:8px; }
    .qty-control input { width:48px; text-align:center; font-family:Arial,sans-serif; margin:0 4px; }
    #completeBtn { margin-top:24px; padding:10px 20px; font-size:1rem; cursor:pointer; }
    #loading { font-style:italic; }
    /* Highlight styles */
    .highlight-maroon { background-color: rgba(128,0,0,0.1); }
    .highlight-yellow { background-color: rgba(255,255,0,0.1); }
    .highlight-grey   { background-color: rgba(128,128,128,0.1); }
    /* Login screen */
    #login { text-align:center; }
    #login input { padding:8px; font-size:1rem; width:80%; margin-bottom:12px; }
    #login button { padding:10px 20px; font-size:1rem; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login">
    <h1>Welcome to Stocktake</h1>
    <input id="username" type="text" placeholder="Enter your name" />
    <br/>
    <button id="loginBtn">Continue</button>
  </div>

  <!-- Main App Container -->
  <div id="appContainer" style="display:none;">
    <h1>📋 Stocktake<span id="date"></span></h1>
    <div id="loading">Loading…</div>
    <div id="app" style="display:none;">
      <h2>KEGS</h2><ul id="kegList"></ul>
      <h2>CANS</h2><ul id="canList"></ul>
      <button id="completeBtn">Complete</button>
    </div>
  </div>

  <script>
    const API = '/api/inventory';
    let items = [];
    let userName = '';

    // Utilities
    function formatToday() {
      const d = new Date();
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(-2)}`;
    }

    // Load stock after login
    async function loadStock() {
      document.getElementById('date').textContent = ' ' + formatToday() + ' - ' + userName;
      const res = await fetch(API);
      const { stock } = await res.json();

      // Build items[], include clearCount and preserve rawName
      items = stock.reduce((arr, item) => {
        let raw = (item.rawName||'').trim();
        if (!raw) return arr;
        raw = raw.replace(/^\d{2}\.\s*/, '');
        const [namePart, info=''] = raw.split('//').map(s=>s.trim());
        const prefix = namePart.slice(0,3).toUpperCase();
        const curMon = new Date().toLocaleString('en-US',{month:'short'}).toUpperCase();
        const MONTHS = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
        if (MONTHS.includes(prefix) && prefix !== curMon) return arr;
        const unit = info.replace(/.*?%\s*/, '');
        arr.push({ rawName: raw, name: namePart, unit, initialCount: item.initialCount, quantity: item.quantity, clearCount: 0 });
        return arr;
      }, []);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      renderLists();
      document.getElementById('completeBtn').onclick = complete;
    }

    function renderLists() {
      // KEGS section
      let kegs = items.filter(i=>i.unit.toUpperCase().includes('KEG'));

      // Sectioned sorting
      const section20 = kegs.filter(i=>/20|EXP|EXPORT/i.test(i.unit))
                           .sort((a,b)=>a.name.localeCompare(b.name));
      const section30 = kegs.filter(i=>!/20|EXP|EXPORT/i.test(i.unit) && /30/.test(i.unit))
                           .sort((a,b)=>a.name.localeCompare(b.name));
      const section50 = kegs.filter(i=>!/20|EXP|EXPORT/i.test(i.unit) && !/30/.test(i.unit) && /50/.test(i.unit))
                           .sort((a,b)=>a.name.localeCompare(b.name));
      const rest     = kegs.filter(i=>!/20|EXP|EXPORT|30|50/i.test(i.unit));
      kegs = [...section20, ...section30, ...section50, ...rest];

      // CANS section
      let cans = items.filter(i=>i.unit.toUpperCase().includes('ML'));
      // Special last and bold
      const special = cans.filter(i=>i.rawName.includes('SIDE PIECE GIN // 42% 6X700ML'));
      const normalCans = cans.filter(i=>!i.rawName.includes('SIDE PIECE GIN // 42% 6X700ML'));
      cans = normalCans.sort((a,b)=>a.name.localeCompare(b.name)).concat(special);

      renderGroup('kegList', kegs);
      renderGroup('canList', cans);
    }

    function renderGroup(id, list) {
      const ul = document.getElementById(id);
      ul.innerHTML = '';

      list.forEach(item => {
        const li = document.createElement('li');

        // Highlight by unit
        if (/20|EXP|EXPORT/i.test(item.unit)) {
          li.classList.add('highlight-maroon');
        } else if (/\b30\b/.test(item.unit)) {
          li.classList.add('highlight-yellow');
        } else if (/50/.test(item.unit)) {
          li.classList.add('highlight-grey');
        }

        // Name + unit
        const spanN = document.createElement('span');
        spanN.className = 'name';
        spanN.textContent = item.name;
        // Bold special cans
        if (item.rawName.includes('SIDE PIECE GIN // 42% 6X700ML')) {
          spanN.style.fontWeight = 'bold';
        }
        const spanU = document.createElement('span');
        spanU.className = 'unit';
        spanU.textContent = item.unit;
        li.append(spanN, spanU);

        // Initial + tick
        const spanI = document.createElement('span');
        spanI.className = 'initial';
        spanI.textContent = item.initialCount;
        const btnT = document.createElement('button');
        btnT.className = 'tick';
        btnT.innerText = '✔️';
        btnT.title = 'Carry forward';
        btnT.onclick = () => { item.quantity = item.initialCount; renderLists(); };
        li.append(spanI, btnT);

        // Qty controls
        const ctr = document.createElement('span');
        ctr.className = 'qty-control';
        const m = document.createElement('button'); m.innerText = '−';
        m.onclick = () => { let q=+item.quantity||0; item.quantity=Math.max(0,q-1); renderLists(); };
        const inp = document.createElement('input'); inp.type='number'; inp.value=item.quantity;
        inp.oninput = e=>item.quantity=e.target.value;
        const p = document.createElement('button'); p.innerText = '+';
        p.onclick = () => { let q=+item.quantity||0; item.quantity=q+1; renderLists(); };
        ctr.append(m, inp, p);
        li.append(ctr);

        // Clear / delete (trash)
        const btnC = document.createElement('button');
        btnC.className = 'clear'; btnC.innerText = '🗑️';
        btnC.onclick = () => {
          item.clearCount = (item.clearCount || 0) + 1;
          if (item.clearCount >= 3) {
            item.quantity = 0;
            item.clearCount = 0;
          } else {
            item.quantity = '';
          }
          renderLists();
        };
        li.append(btnC);

        ul.append(li);
      });
    }

    async function complete() {
      // Exclude zeros (deleted)
      const out = items
        .filter(i => !(i.quantity === 0 || i.quantity === '0'))
        .map(i => ({ name: `${i.name} // ${i.unit}`, quantity: i.quantity }));

      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stock: out, name: userName })
      });
      const { success } = await res.json();
      alert(success ? '✅ Saved!' : '❌ Error');
      loadStock();
    }

    // Initialize login flow
    window.onload = () => {
      document.getElementById('loginBtn').onclick = () => {
        const input = document.getElementById('username');
        const name = input.value.trim();
        if (!name) {
          alert('Please enter your name');
          return;
        }
        userName = name;
        document.getElementById('login').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        loadStock();
      };
    };
  </script>
</body>
</html>
