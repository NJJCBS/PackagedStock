<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stocktake App</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; max-width:600px; margin:auto }
    h1 { margin-bottom:0.5rem; }
    #date { font-weight:normal; font-size:1rem; margin-left:8px; }
    h2 { margin-top:1.5rem; font-size:1.1rem; }
    ul { list-style:none; padding:0; }
    li { display:flex; align-items:center; margin:6px 0; }
    .qty-control input::-webkit-outer-spin-button,
    .qty-control input::-webkit-inner-spin-button {
      -webkit-appearance: none; margin: 0;
    }
    .qty-control input { -moz-appearance: textfield; }
    .name { flex:1; font-size:1rem; }
    .unit { font-size:0.7rem; color:#555; margin-left:6px; }
    .initial { opacity:0.3; margin-left:8px; width:30px; text-align:right; }
    .tick, .clear, .qty-control button {
      background:none; border:none; cursor:pointer; padding:0 4px; font-size:1rem;
    }
    .qty-control { display:flex; align-items:center; margin-left:8px; }
    .qty-control input {
      width:48px; text-align:center; font-family:Arial,sans-serif; margin:0 4px;
    }
    #completeBtn { margin-top:24px; padding:10px 20px; font-size:1rem; cursor:pointer; }
    #loading { font-style:italic; }
    /* hide login until CSS loads */
    #app, #date, #completeBtn { display: none; }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="login">
    <h1>Welcome to Stocktake</h1>
    <label>
      Enter your name:
      <input id="nameInput" type="text" placeholder="e.g. NICK" />
    </label>
    <button id="startBtn">Continue</button>
  </div>

  <!-- MAIN APP -->
  <h1>üìã Stocktake<span id="date"></span></h1>
  <div id="loading">Loading‚Ä¶</div>
  <div id="app">
    <h2>KEGS</h2><ul id="kegList"></ul>
    <h2>CANS</h2><ul id="canList"></ul>
    <button id="completeBtn">Complete</button>
  </div>

  <script>
    const API = '/api/inventory';
    let items = [];
    let userName = '';

    // format DD/MM/YY
    function formatToday() {
      const d = new Date();
      return `${String(d.getDate()).padStart(2,'0')}/${
              String(d.getMonth()+1).padStart(2,'0')}/${
              String(d.getFullYear()).slice(-2)}`;
    }

    // after login, load stock
    document.getElementById('startBtn').onclick = () => {
      const nameIn = document.getElementById('nameInput').value.trim();
      if (!nameIn) return alert('Please enter your name');
      userName = nameIn.toUpperCase();
      document.getElementById('login').style.display = 'none';
      document.getElementById('date').style.display = 'inline';
      document.getElementById('completeBtn').style.display = 'inline';
      loadStock();
    };

    async function loadStock() {
      document.getElementById('date').textContent = ' ' + formatToday() + ' - ' + userName;
      const res = await fetch(API);
      const { stock } = await res.json();
      items = stock.map(item => ({
        id: item.id,
        rawName: item.rawName,
        initialCount: item.initialCount,
        quantity: item.quantity,
        trashClicks: 0
      }));
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      renderLists();
      document.getElementById('completeBtn').onclick = complete;
    }

    function renderLists() {
      const kegs = items.filter(i => i.unit && i.unit.toUpperCase().includes('KEG'));
      const cans = items.filter(i => i.unit && !i.unit.toUpperCase().includes('KEG'));
      renderGroup('kegList', kegs);
      renderGroup('canList', cans);
    }

    function renderGroup(id, list) {
      const ul = document.getElementById(id);
      ul.innerHTML = '';
      list.forEach(item => {
        const li = document.createElement('li');
        const spanN = Object.assign(document.createElement('span'), {
          className: 'name', textContent: item.rawName.split('//')[0].trim()
        });
        const spanU = Object.assign(document.createElement('span'), {
          className: 'unit', textContent: item.rawName.split('//')[1]?.trim() || ''
        });
        const spanI = Object.assign(document.createElement('span'), {
          className: 'initial', textContent: item.initialCount
        });
        // tick button
        const btnT = Object.assign(document.createElement('button'), {
          className:'tick', innerText:'‚úîÔ∏è', title:'Carry forward'
        });
        btnT.onclick = () => { item.quantity = item.initialCount; renderLists(); };

        // qty controls
        const ctr = document.createElement('span'); ctr.className = 'qty-control';
        const m = Object.assign(document.createElement('button'),{innerText:'‚àí'});
        m.onclick = () => { 
          let q = +item.quantity || 0; 
          item.quantity = Math.max(0, q-1); 
          renderLists();
        };
        const inp = document.createElement('input');
        inp.type = 'number'; inp.value = item.quantity;
        inp.oninput = e => item.quantity = e.target.value;
        const p = Object.assign(document.createElement('button'),{innerText:'+'});
        p.onclick = () => { 
          let q = +item.quantity || 0; 
          item.quantity = q+1; 
          renderLists();
        };
        ctr.append(m, inp, p);

        // trash button
        const btnC = Object.assign(document.createElement('button'),{
          className:'clear', innerText:'üóëÔ∏è'
        });
        btnC.onclick = () => {
          item.trashClicks++;
          if (item.trashClicks >= 3) {
            item.quantity = '0';
            item.trashClicks = 0;
          }
          renderLists();
        };

        li.append(spanN, spanU, spanI, btnT, ctr, btnC);
        ul.append(li);
      });
    }

    async function complete() {
      // send only those you‚Äôve touched (including zeros for deletion)
      const out = items
        .filter(i => i.quantity !== '' )
        .map(i => ({ id: i.id, quantity: i.quantity }));
      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ name: userName, stock: out })
      });
      const { success } = await res.json();
      alert(success ? '‚úÖ Saved!' : '‚ùå Error');
      // reload
      loadStock();
    }
  </script>
</body>
</html>
