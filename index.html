<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stocktake App</title>
  <style>
    /*‚Äî Overall font and layout ‚Äî*/
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      margin-bottom: 1rem;
    }
    h2 {
      margin-top: 2rem;
      font-size: 1.2rem;
    }
    h2 b {
      font-size: 1.2rem;
    }
    /*‚Äî Loading indicator ‚Äî*/
    #loading {
      font-style: italic;
    }
    /*‚Äî Stock list styling ‚Äî*/
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }
    /*‚Äî Initial count (column C) ‚Äî*/
    .initial {
      opacity: 0.3;
      width: 30px;
      text-align: right;
      margin-right: 8px;
    }
    /*‚Äî Tick button ‚Äî*/
    .tick {
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 8px;
    }
    /*‚Äî Name & unit ‚Äî*/
    .name {
      flex: 1;
      font-size: 1rem;
    }
    .unit {
      font-size: 0.7rem;
      color: #555;
      margin-left: 8px;
    }
    /*‚Äî Quantity input & controls ‚Äî*/
    .qty-control {
      display: flex;
      align-items: center;
      margin-left: 8px;
    }
    .qty-control button {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      padding: 4px;
    }
    .qty-control input {
      width: 50px;
      text-align: center;
      margin: 0 4px;
      font-family: Arial, sans-serif;
    }
    /*‚Äî Clear (bin) button ‚Äî*/
    .clear {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 8px;
    }
    /*‚Äî Complete button ‚Äî*/
    #completeBtn {
      margin-top: 24px;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üìã Stocktake</h1>
  <div id="loading">Loading‚Ä¶</div>
  <div id="app" style="display:none;">
    <!-- KEGS group -->
    <h2><b>KEGS</b></h2>
    <ul id="kegList"></ul>
    <!-- CANS group -->
    <h2><b>CANS</b></h2>
    <ul id="canList"></ul>
    <button id="completeBtn">Complete</button>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyJT539HNbZcMqXVm_lXB1lwD1VyFd-mVG-q_nCZaKOKc4zxn7Y38jg_u1hpu3g7q7n/exec';

    let rawStock = [];

    // month names to filter out
    const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    async function loadStock() {
      try {
        const res = await fetch(API_URL);
        const { stock } = await res.json();  // stock: [{ rawName, initialCount, quantity }]
        rawStock = stock.map(item => ({
          rawName:       item.rawName || item.name,    // if using old API, fallback to name
          initialCount:  item.initialCount ?? 0,
          quantity:      item.quantity ?? "",
        }));
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        renderLists();
        document.getElementById('completeBtn').onclick = complete;
      } catch (err) {
        console.error(err);
        document.getElementById('loading').textContent = 'Error loading data.';
      }
    }

    function cleanItem(item) {
      let name = item.rawName.trim();

      // 1) filter out month-prefixed entries
      for (let m of MONTHS) {
        if (name.startsWith(m + ' ')) return null;
      }
      // 2) remove leading "NN." prefix
      name = name.replace(/^\d{2}\.\s*/, '');

      // 3) split off ABV and unit
      //    format: "Beer Name // XX.X% 20L KEG" or similar
      const [before, after] = name.split('//');
      name = before ? before.trim() : name;

      // 4) extract unit (last token)
      const tokens = name.split(' ');
      const unit = tokens[tokens.length - 1];
      const cleanName = tokens.slice(0, -1).join(' ');

      return {
        cleanName,
        unit,
        initialCount: item.initialCount,
        quantity: item.quantity
      };
    }

    function renderLists() {
      const kegs = [];
      const cans = [];

      for (let item of rawStock) {
        const c = cleanItem(item);
        if (!c) continue;  // skip month entries

        if (c.unit.toUpperCase().includes('KEG')) kegs.push(c);
        else if (c.unit.toUpperCase().includes('ML')) cans.push(c);
      }

      renderGroup('kegList', kegs);
      renderGroup('canList', cans);
    }

    function renderGroup(listId, items) {
      const ul = document.getElementById(listId);
      ul.innerHTML = '';
      items.forEach((item, i) => {
        const li = document.createElement('li');

        // initial count
        const spanInit = document.createElement('span');
        spanInit.className = 'initial';
        spanInit.textContent = item.initialCount;
        li.append(spanInit);

        // tick button
        const tick = document.createElement('button');
        tick.className = 'tick';
        tick.textContent = '‚úîÔ∏è';
        tick.title = 'Carry forward';
        tick.onclick = () => {
          item.quantity = item.initialCount;
          renderLists();
        };
        li.append(tick);

        // name
        const spanName = document.createElement('span');
        spanName.className = 'name';
        spanName.textContent = item.cleanName;
        li.append(spanName);

        // unit
        const spanUnit = document.createElement('span');
        spanUnit.className = 'unit';
        spanUnit.textContent = item.unit;
        li.append(spanUnit);

        // qty controls: -, input, +
        const ctr = document.createElement('span');
        ctr.className = 'qty-control';

        const btnMinus = document.createElement('button');
        btnMinus.textContent = '‚àí';
        btnMinus.onclick = () => {
          let q = parseInt(item.quantity) || 0;
          item.quantity = Math.max(0, q - 1);
          renderLists();
        };
        ctr.append(btnMinus);

        const inp = document.createElement('input');
        inp.type = 'number';
        inp.value = item.quantity;
        inp.oninput = e => {
          item.quantity = e.target.value;
        };
        ctr.append(inp);

        const btnPlus = document.createElement('button');
        btnPlus.textContent = '+';
        btnPlus.onclick = () => {
          let q = parseInt(item.quantity) || 0;
          item.quantity = q + 1;
          renderLists();
        };
        ctr.append(btnPlus);

        li.append(ctr);

        // clear/bin button
        const clr = document.createElement('button');
        clr.className = 'clear';
        clr.textContent = 'üóëÔ∏è';
        clr.onclick = () => {
          item.quantity = '';
          renderLists();
        };
        li.append(clr);

        ul.append(li);
      });
    }

    async function complete() {
      try {
        // send only cleanName, unit, quantity array back
        const out = [];
        [...document.getElementById('kegList').children,
           ...document.getElementById('canList').children]
          .forEach(li => {
            const name = li.querySelector('.name').textContent;
            const unit = li.querySelector('.unit').textContent;
            const qty  = li.querySelector('input').value;
            out.push({ name: name + ' ' + unit, quantity: qty });
          });

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stock: out })
        });
        const result = await res.json();
        alert(result.success ? '‚úÖ Saved!' : '‚ùå Error');
        loadStock();
      } catch (err) {
        console.error(err);
        alert('Error saving data.');
      }
    }

    window.onload = loadStock;
  </script>
</body>
</html>
